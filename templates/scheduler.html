{% extends "base.html" %}

{% block title %}–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ - Job Parser{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h2 class="mb-4">üïê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h2>

        <!-- –ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-success" id="startSchedulerBtn">
                                        <span id="startSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        ‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                                    </button>
                                    <button class="btn btn-danger" id="stopSchedulerBtn">
                                        <span id="stopSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        ‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="d-grid gap-2">
                                    <button class="btn btn-info" id="refreshStatusBtn">
                                        <span id="refreshSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å
                                    </button>
                                    <button class="btn btn-outline-danger" id="clearAllJobsBtn">
                                        <span id="clearAllSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                        üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –∑–∞–¥–∞—á–∏
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div id="schedulerStatus" class="alert alert-secondary">
                            <div class="text-center">
                                <div class="spinner-border" role="status">
                                    <span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
                                </div>
                                <div class="mt-2">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ–∏—Å–∫–∞ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">üîç –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞</h5>
            </div>
            <div class="card-body">
                <form id="searchJobForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ <span class="text-danger">*</span></label>
                                <textarea class="form-control" id="searchKeywords" rows="5"
                                    placeholder="Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫&#10;Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫&#10;Data Scientist&#10;DevOps –∏–Ω–∂–µ–Ω–µ—Ä&#10;Fullstack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫" required></textarea>
                                <div class="form-text">–ö–∞–∂–¥–æ–µ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏</div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª –ø–æ–∏—Å–∫–∞ (–º–∏–Ω—É—Ç—ã) <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="searchInterval"
                                               min="1" step="1" value="120" required>
                                        <div class="form-text">–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è: 60-180 –º–∏–Ω—É—Ç</div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">–õ–∏–º–∏—Ç –≤–∞–∫–∞–Ω—Å–∏–π</label>
                                        <select class="form-select" id="searchLimit">
                                            <option value="10">10 –≤–∞–∫–∞–Ω—Å–∏–π</option>
                                            <option value="20" selected>20 –≤–∞–∫–∞–Ω—Å–∏–π</option>
                                            <option value="30">30 –≤–∞–∫–∞–Ω—Å–∏–π</option>
                                            <option value="50">50 –≤–∞–∫–∞–Ω—Å–∏–π</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">–ì–æ—Ä–æ–¥ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                                <input type="text" class="form-control" id="searchCity"
                                       placeholder="–ú–æ—Å–∫–≤–∞, –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥, –ö–∞–∑–∞–Ω—å...">
                                <div class="form-text">–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –≤—Å–µ–º –≥–æ—Ä–æ–¥–∞–º</div>
                            </div>

                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="startImmediately">
                                <label class="form-check-label">
                                    –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–∏—Å–∫ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                                </label>
                            </div>

                            <button type="submit" class="btn btn-primary">
                                <span id="addJobSpinner" class="spinner-border spinner-border-sm me-2" style="display: none;"></span>
                                ‚ûï –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–ø–æ–∏—Å–∫
                            </button>
                        </div>

                        <div class="col-md-6">
                            <div class="alert alert-info">
                                <h6>üìã –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</h6>
                                <ul class="mb-0">
                                    <li>–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—â–µ—Ç –≤–∞–∫–∞–Ω—Å–∏–∏ –ø–æ —É–∫–∞–∑–∞–Ω–Ω—ã–º –∫–ª—é—á–µ–≤—ã–º —Å–ª–æ–≤–∞–º</li>
                                    <li>–ü–æ–∏—Å–∫ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –Ω–∞ HH.ru –∏ SuperJob</li>
                                    <li>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö</li>
                                    <li>–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–Ω—ã—Ö –∑–∞–¥–∞—á –ø–æ–∏—Å–∫–∞</li>
                                </ul>
                            </div>

                            <div class="alert alert-warning">
                                <h6>‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</h6>
                                <ul class="mb-0">
                                    <li><strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</strong> 60-180 –º–∏–Ω—É—Ç (–≤–æ –∏–∑–±–µ–∂–∞–Ω–∏–µ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏)</li>
                                    <li><strong>–ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞:</strong> –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã</li>
                                    <li><strong>–õ–∏–º–∏—Ç:</strong> 20-30 –≤–∞–∫–∞–Ω—Å–∏–π –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ</li>
                                </ul>
                            </div>

                            <div class="alert alert-success">
                                <h6>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:</h6>
                                <div class="d-grid gap-2">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="setQuickSearch('python')">
                                        üêç Python —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
                                    </button>
                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="setQuickSearch('frontend')">
                                        üé® Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∞
                                    </button>
                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="setQuickSearch('popular')">
                                        ‚≠ê –ü–æ–ø—É–ª—è—Ä–Ω—ã–µ IT –ø—Ä–æ—Ñ–µ—Å—Å–∏–∏
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üìã –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞</h5>
            </div>
            <div class="card-body">
                <div id="searchJobsList">
                    <div class="text-center text-muted">
                        –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–∞—á...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
class SchedulerManager {
    constructor() {
        this.statusCheckInterval = null;
        this.init();
    }

    init() {
        this.bindEvents();
        this.loadStatus();
        this.startAutoRefresh();
    }

    bindEvents() {
        document.getElementById('startSchedulerBtn').addEventListener('click', () => this.startScheduler());
        document.getElementById('stopSchedulerBtn').addEventListener('click', () => this.stopScheduler());
        document.getElementById('refreshStatusBtn').addEventListener('click', () => this.loadStatus());
        document.getElementById('clearAllJobsBtn').addEventListener('click', () => this.clearAllJobs());
        document.getElementById('searchJobForm').addEventListener('submit', (e) => this.addSearchJob(e));
    }

    async startScheduler() {
        this.setButtonLoading('startSchedulerBtn', true);

        try {
            const response = await fetch('/api/scheduler/start', { method: 'POST' });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            this.showMessage('‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∑–∞–ø—É—â–µ–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
            setTimeout(() => this.loadStatus(), 1000);

        } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞: ' + error.message, 'danger');
        } finally {
            this.setButtonLoading('startSchedulerBtn', false);
        }
    }

    async stopScheduler() {
        if (!confirm('‚ö†Ô∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫? –í—Å–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –ø–æ–∏—Å–∫–∞ –±—É–¥—É—Ç –ø—Ä–µ–∫—Ä–∞—â–µ–Ω—ã.')) return;

        this.setButtonLoading('stopSchedulerBtn', true);

        try {
            const response = await fetch('/api/scheduler/stop', { method: 'POST' });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            this.showMessage('‚èπÔ∏è –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'warning');
            setTimeout(() => this.loadStatus(), 1000);

        } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: ' + error.message, 'danger');
        } finally {
            this.setButtonLoading('stopSchedulerBtn', false);
        }
    }

    async clearAllJobs() {
        if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï! –£–¥–∞–ª–∏—Ç—å –í–°–ï –∑–∞–¥–∞—á–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞?\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) return;

        this.setButtonLoading('clearAllJobsBtn', true);

        try {
            const response = await fetch('/api/scheduler/clear-all-jobs', { method: 'DELETE' });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            this.showMessage(`‚úÖ –í—Å–µ –∑–∞–¥–∞—á–∏ –æ—á–∏—â–µ–Ω—ã. –£–¥–∞–ª–µ–Ω–æ: ${data.deleted_count}`, 'warning');
            setTimeout(() => this.loadStatus(), 1000);

        } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
        } finally {
            this.setButtonLoading('clearAllJobsBtn', false);
        }
    }

    async loadStatus() {
        this.setButtonLoading('refreshStatusBtn', true);

        try {
            const response = await fetch('/api/scheduler/status');
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            this.displayStatus(data);
            this.displayJobs(data.jobs || {});

        } catch (error) {
            this.showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç—É—Å–∞: ' + error.message);
        } finally {
            this.setButtonLoading('refreshStatusBtn', false);
        }
    }

    async addSearchJob(e) {
        e.preventDefault();

        const keywords = document.getElementById('searchKeywords').value.trim();
        const interval = parseInt(document.getElementById('searchInterval').value);
        const city = document.getElementById('searchCity').value.trim();
        const limit = parseInt(document.getElementById('searchLimit').value);
        const startImmediately = document.getElementById('startImmediately').checked;

        if (!keywords) {
            this.showMessage('‚ùå –£–∫–∞–∂–∏—Ç–µ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞', 'danger');
            return;
        }

        if (interval < 1) {
            this.showMessage('‚ùå –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª: 1 –º–∏–Ω—É—Ç–∞', 'danger');
            return;
        }

        this.setButtonLoading('addJobSpinner', true);

        try {
            const response = await fetch('/api/scheduler/add-search-job', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    keywords: keywords,
                    interval_minutes: interval,
                    city: city,
                    limit: limit,
                    run_immediately: startImmediately
                })
            });

            const data = await response.json();

            if (data.error) throw new Error(data.error);

            this.showMessage(`‚úÖ ${data.message}`, 'success');
            document.getElementById('searchJobForm').reset();
            document.getElementById('searchInterval').value = 120;
            document.getElementById('searchLimit').value = 20;

            setTimeout(() => this.loadStatus(), 1000);

        } catch (error) {
            this.showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
        } finally {
            this.setButtonLoading('addJobSpinner', false);
        }
    }

    displayStatus(data) {
        const container = document.getElementById('schedulerStatus');
        const isRunning = data.running;
        const jobsCount = Object.keys(data.jobs || {}).length;

        const statusClass = isRunning ? 'alert-success' : 'alert-warning';
        const statusIcon = isRunning ? 'üü¢' : 'üî¥';
        const statusText = isRunning ? '–†–∞–±–æ—Ç–∞–µ—Ç' : '–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω';

        container.className = `alert ${statusClass}`;
        container.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="mb-1">${statusIcon} –°—Ç–∞—Ç—É—Å: ${statusText}</h6>
                    <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á: ${jobsCount}</small>
                </div>
                <div class="text-end">
                    <small class="text-muted">–û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString('ru-RU')}</small>
                </div>
            </div>
        `;

        document.getElementById('startSchedulerBtn').disabled = isRunning;
        document.getElementById('stopSchedulerBtn').disabled = !isRunning;
    }

    displayJobs(jobs) {
        const container = document.getElementById('searchJobsList');
        const allJobs = Object.entries(jobs);

        if (allJobs.length === 0) {
            container.innerHTML = `
                <div class="text-center text-muted">
                    <p>üì≠ –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–¥–∞—á</p>
                    <small>–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∏—Å–ø–æ–ª—å–∑—É—è —Ñ–æ—Ä–º—É –≤—ã—à–µ</small>
                </div>
            `;
            return;
        }

        let html = '<div class="row">';

        for (const [jobId, job] of allJobs) {
            const nextRun = new Date(job.next_run).toLocaleString('ru-RU');
            const lastRun = job.last_run !== '–ù–∏–∫–æ–≥–¥–∞' ? new Date(job.last_run).toLocaleString('ru-RU') : '–ù–∏–∫–æ–≥–¥–∞';

            html += `
                <div class="col-md-6 mb-3">
                    <div class="card border-primary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">üîç –ê–≤—Ç–æ–ø–æ–∏—Å–∫ –≤–∞–∫–∞–Ω—Å–∏–π</h6>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-success btn-sm" onclick="runJobNow('${jobId}')" title="–ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ–π—á–∞—Å">
                                        ‚ñ∂Ô∏è
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="removeJob('${jobId}')" title="–£–¥–∞–ª–∏—Ç—å">
                                        üóëÔ∏è
                                    </button>
                                </div>
                            </div>
                            <p class="card-text small">
                                <strong>ID:</strong> <code>${jobId}</code><br>
                                <strong>–°–ª–µ–¥—É—é—â–∏–π –ø–æ–∏—Å–∫:</strong> ${nextRun}<br>
                                <strong>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–∏—Å–∫:</strong> ${lastRun}<br>
                                <strong>–ò–Ω—Ç–µ—Ä–≤–∞–ª:</strong> ${job.interval_minutes} –º–∏–Ω<br>
                                <strong>–í—ã–ø–æ–ª–Ω–µ–Ω–æ –ø–æ–∏—Å–∫–æ–≤:</strong> ${job.run_count}
                            </p>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-primary" style="width: ${Math.min((job.run_count * 5), 100)}%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        html += '</div>';
        container.innerHTML = html;
    }

    setButtonLoading(buttonId, isLoading) {
        const btn = document.getElementById(buttonId);
        const spinnerId = buttonId.replace('Btn', 'Spinner');
        const spinner = document.getElementById(spinnerId);

        if (isLoading) {
            btn.disabled = true;
            if (spinner) spinner.style.display = 'inline-block';
        } else {
            btn.disabled = false;
            if (spinner) spinner.style.display = 'none';
        }
    }

    showMessage(message, type) {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = `
            top: 20px; right: 20px; z-index: 9999; max-width: 400px;
            opacity: 0; transition: opacity 0.3s ease;
        `;
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;

        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '1'; }, 10);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
        }, 5000);
    }

    showError(message) {
        this.showMessage(message, 'danger');
    }

    startAutoRefresh() {
        this.statusCheckInterval = setInterval(() => this.loadStatus(), 30000);
    }

    stopAutoRefresh() {
        if (this.statusCheckInterval) clearInterval(this.statusCheckInterval);
    }
}

// –ë—ã—Å—Ç—Ä—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
function setQuickSearch(type) {
    const keywordsInput = document.getElementById('searchKeywords');
    const intervalInput = document.getElementById('searchInterval');

    let keywords = '';
    let interval = 120;

    if (type === 'python') {
        keywords = 'Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nDjango —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nFlask —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nFastAPI —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫';
        interval = 90;
    } else if (type === 'frontend') {
        keywords = 'Frontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nReact —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nVue —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nJavaScript —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫';
        interval = 120;
    } else if (type === 'popular') {
        keywords = 'Python —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nFrontend —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫\nData Scientist\nDevOps –∏–Ω–∂–µ–Ω–µ—Ä\nFullstack —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫';
        interval = 180;
    }

    keywordsInput.value = keywords;
    intervalInput.value = interval;

    schedulerManager.showMessage(`‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ "${type}" –ø—Ä–∏–º–µ–Ω–µ–Ω—ã`, 'info');
}

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
async function runJobNow(jobId) {
    try {
        const response = await fetch(`/api/scheduler/run-job-now/${jobId}`, { method: 'POST' });
        const data = await response.json();

        if (data.error) throw new Error(data.error);

        schedulerManager.showMessage(`‚úÖ –ü–æ–∏—Å–∫ –∑–∞–ø—É—â–µ–Ω!`, 'success');

    } catch (error) {
        schedulerManager.showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

async function removeJob(jobId) {
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É "${jobId}"?`)) return;

    try {
        const response = await fetch(`/api/scheduler/remove-job/${jobId}`, { method: 'DELETE' });
        const data = await response.json();

        if (data.error) throw new Error(data.error);

        schedulerManager.showMessage(`‚úÖ –ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞`, 'success');
        setTimeout(() => schedulerManager.loadStatus(), 1000);

    } catch (error) {
        schedulerManager.showMessage('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'danger');
    }
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
let schedulerManager;
document.addEventListener('DOMContentLoaded', function() {
    schedulerManager = new SchedulerManager();
});

window.addEventListener('beforeunload', function() {
    if (schedulerManager) schedulerManager.stopAutoRefresh();
});
</script>
{% endblock %}