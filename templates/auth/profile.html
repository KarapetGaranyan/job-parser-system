<!-- templates/auth/profile.html - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è - Job Parser System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .navbar-brand { font-weight: bold; }
        .user-info { font-size: 0.9em; }
        .profile-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
        }
        .profile-body {
            background: white;
            color: #333;
            border-radius: 0 0 15px 15px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">üîç Job Parser</a>

            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/">–ü–æ–∏—Å–∫</a>
                <a class="nav-link" href="/vacancies">–í–∞–∫–∞–Ω—Å–∏–∏</a>
                <a class="nav-link" href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a class="nav-link" href="/scheduler">üïê –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</a>
                <a class="nav-link active" href="/auth/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                <a class="nav-link" href="/api/vacancies">API</a>
                <a class="nav-link" href="/export/text">–¢–µ–∫—Å—Ç</a>
                <a class="nav-link" href="/export/csv">CSV</a>
            </div>

            <div class="navbar-nav">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle user-info" href="#" role="button" data-bs-toggle="dropdown">
                        üë§ {{ session.user if session.user else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}
                        {% if session.role == 'admin' %}
                            <span class="badge bg-warning ms-1">admin</span>
                        {% endif %}
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/auth/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a></li>
                        {% if session.role == 'admin' %}
                            <li><a class="dropdown-item" href="/auth/admin">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
                        {% endif %}
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/auth/logout">üö™ –í—ã–π—Ç–∏</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card profile-card">
                    <div class="card-header text-center py-4">
                        <h2 class="mb-1">üë§</h2>
                        <h4 class="mb-0">–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h4>
                        <p class="mb-0 opacity-75">{{ session.user if session.user else '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}</p>
                    </div>

                    <div class="card-body profile-body">
                        <table class="table table-borderless">
                            <tr>
                                <td><strong>–õ–æ–≥–∏–Ω:</strong></td>
                                <td><code>{{ session.user if session.user else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</code></td>
                            </tr>
                            <tr>
                                <td><strong>–†–æ–ª—å:</strong></td>
                                <td>
                                    {% if session.role == 'admin' %}
                                        <span class="badge bg-danger">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                                    {% elif session.role == 'user' %}
                                        <span class="badge bg-primary">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                                    {% elif session.role == 'guest' %}
                                        <span class="badge bg-secondary">–ì–æ—Å—Ç—å</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">{{ session.role if session.role else '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–î–æ—Å—Ç—É–ø –¥–æ:</strong></td>
                                <td id="access-info">
                                    {% if session.expires %}
                                        <span class="text-info">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø</span>
                                    {% else %}
                                        <span class="text-success fw-bold">–ë–µ—Å—Å—Ä–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <td><strong>–°–µ—Å—Å–∏—è:</strong></td>
                                <td>
                                    <span class="text-success">‚úÖ –ê–∫—Ç–∏–≤–Ω–∞</span>
                                    <small class="text-muted d-block">–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω</small>
                                </td>
                            </tr>
                        </table>

                        <!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤ -->
                        {% if session.role == 'admin' %}
                        <div class="alert alert-info">
                            <h6 class="alert-heading">üîß –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ –ø—Ä–∞–≤–∞</h6>
                            <p class="mb-0">–£ –≤–∞—Å –µ—Å—Ç—å –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ:</p>
                            <ul class="mb-0 mt-2">
                                <li>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</li>
                                <li>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–æ–º</li>
                                <li>–î–æ—Å—Ç—É–ø –∫–æ –≤—Å–µ–º —Ñ—É–Ω–∫—Ü–∏—è–º</li>
                            </ul>
                        </div>
                        {% endif %}

                        <div class="mt-4 d-flex gap-2 flex-wrap">
                            {% if session.role == 'admin' %}
                                <a href="/auth/admin" class="btn btn-warning">
                                    ‚öôÔ∏è –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                                </a>
                            {% endif %}
                            <a href="/" class="btn btn-primary">
                                üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é
                            </a>
                            <a href="/scheduler" class="btn btn-info">
                                üïê –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
                            </a>
                            <a href="/stats" class="btn btn-success">
                                üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                            </a>
                            <a href="/auth/logout" class="btn btn-outline-secondary">
                                üö™ –í—ã–π—Ç–∏
                            </a>
                        </div>

                        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ -->
                        <div class="mt-4">
                            <h6>üìà –ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h6>
                            <div class="row text-center">
                                <div class="col-4">
                                    <div class="bg-light p-2 rounded">
                                        <strong id="session-time">--</strong>
                                        <small class="d-block text-muted">–í—Ä–µ–º—è —Å–µ—Å—Å–∏–∏</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-light p-2 rounded">
                                        <strong>{{ session.role if session.role else 'guest' }}</strong>
                                        <small class="d-block text-muted">–£—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞</small>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <div class="bg-light p-2 rounded">
                                        <strong class="text-success">–û–Ω–ª–∞–π–Ω</strong>
                                        <small class="d-block text-muted">–°—Ç–∞—Ç—É—Å</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            updateSessionTime();
            setInterval(updateSessionTime, 1000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
        });

        function updateSessionTime() {
            // –ü—Ä–æ—Å—Ç–æ–π —Å—á–µ—Ç—á–∏–∫ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Å—Å–∏–∏
            const now = new Date();
            const sessionStart = sessionStorage.getItem('sessionStart');

            if (!sessionStart) {
                sessionStorage.setItem('sessionStart', now.getTime());
                return;
            }

            const elapsed = Math.floor((now.getTime() - parseInt(sessionStart)) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            document.getElementById('session-time').textContent =
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥–æ—Å—Ç—É–ø–µ –¥–ª—è –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤
        {% if session.expires %}
        function updateAccessInfo() {
            const expiresDate = new Date('{{ session.expires }}');
            const now = new Date();
            const diffTime = expiresDate - now;

            if (diffTime > 0) {
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                const diffHours = Math.ceil(diffTime / (1000 * 60 * 60));

                let accessText = '';
                if (diffDays > 1) {
                    accessText = `<span class="text-info">${diffDays} –¥–Ω–µ–π</span>`;
                } else if (diffHours > 1) {
                    accessText = `<span class="text-warning">${diffHours} —á–∞—Å–æ–≤</span>`;
                } else {
                    accessText = `<span class="text-danger">–ò—Å—Ç–µ–∫–∞–µ—Ç —Å–∫–æ—Ä–æ!</span>`;
                }

                document.getElementById('access-info').innerHTML = accessText +
                    `<small class="d-block text-muted">–¥–æ ${expiresDate.toLocaleDateString()}</small>`;
            } else {
                document.getElementById('access-info').innerHTML =
                    '<span class="text-danger">–î–æ—Å—Ç—É–ø –∏—Å—Ç–µ–∫</span>';
            }
        }

        updateAccessInfo();
        setInterval(updateAccessInfo, 60000); // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        {% endif %}
    </script>
</body>
</html>