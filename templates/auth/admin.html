<!-- templates/auth/admin.html - –í–µ—Ä—Å–∏—è –±–µ–∑ –æ—Ç–ª–∞–¥–∫–∏ -->
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - Job Parser System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .card { box-shadow: 0 2px 4px rgba(0,0,0,0.1); border: none; }
        .navbar-brand { font-weight: bold; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">üîç Job Parser</a>

            <div class="navbar-nav me-auto">
                <a class="nav-link" href="/">–ü–æ–∏—Å–∫</a>
                <a class="nav-link" href="/vacancies">–í–∞–∫–∞–Ω—Å–∏–∏</a>
                <a class="nav-link" href="/stats">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</a>
                <a class="nav-link" href="/scheduler">üïê –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫</a>
                <a class="nav-link" href="/auth/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a>
                <a class="nav-link" href="/api/vacancies">API</a>
                <a class="nav-link" href="/export/text">–¢–µ–∫—Å—Ç</a>
                <a class="nav-link" href="/export/csv">CSV</a>
            </div>

            <div class="navbar-nav">
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        üë§ {{ session.user if session.user else '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä' }}
                        <span class="badge bg-warning ms-1">admin</span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/auth/profile">üë§ –ü—Ä–æ—Ñ–∏–ª—å</a></li>
                        <li><a class="dropdown-item" href="/auth/admin">‚öôÔ∏è –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="/auth/logout">üö™ –í—ã–π—Ç–∏</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Flash messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between">
                        <h5 class="mb-0">üë• –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h5>
                        <div>
                            <button class="btn btn-sm btn-outline-primary me-1" onclick="loadUsers()">
                                üîÑ –û–±–Ω–æ–≤–∏—Ç—å
                            </button>
                            <span id="users-count" class="badge bg-secondary">0</span>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>–õ–æ–≥–∏–Ω</th>
                                        <th>–†–æ–ª—å</th>
                                        <th>–î–æ—Å—Ç—É–ø –¥–æ</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                    </tr>
                                </thead>
                                <tbody id="users-table">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2"></div>
                                            –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="/auth/admin/add_user" id="add-user-form">
                            <div class="mb-3">
                                <label class="form-label">–õ–æ–≥–∏–Ω</label>
                                <input type="text" name="username" class="form-control" required
                                       minlength="3" placeholder="–ú–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
                                <input type="password" name="password" class="form-control" required
                                       minlength="4" placeholder="–ú–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–î–Ω–µ–π –¥–æ—Å—Ç—É–ø–∞</label>
                                <input type="number" name="days" value="30" min="0" max="365" class="form-control">
                                <small class="text-muted">0 = –±–µ—Å—Å—Ä–æ—á–Ω—ã–π –¥–æ—Å—Ç—É–ø</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">–†–æ–ª—å</label>
                                <select name="role" class="form-control">
                                    <option value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</option>
                                    <option value="guest">–ì–æ—Å—Ç—å</option>
                                    <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                                </select>
                            </div>
                            <button type="submit" class="btn btn-primary w-100" id="add-user-btn">
                                ‚ûï –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
        });

        function loadUsers() {
            const tbody = document.getElementById('users-table');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center"><div class="spinner-border spinner-border-sm me-2"></div>–ó–∞–≥—Ä—É–∂–∞–µ–º...</td></tr>';

            fetch('/auth/api/users')
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return response.json();
                })
                .then(users => {
                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                    document.getElementById('users-count').textContent = users.length;

                    tbody.innerHTML = '';

                    if (users.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-warning">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>';
                        return;
                    }

                    users.forEach(user => {
                        const row = document.createElement('tr');
                        if (user.is_expired) {
                            row.className = 'table-danger';
                        }

                        row.innerHTML = `
                            <td>
                                <strong>${user.username}</strong>
                                ${user.username === '{{ session.user }}' ? '<span class="badge bg-info ms-1">–í—ã</span>' : ''}
                            </td>
                            <td>
                                <span class="badge bg-${user.role === 'admin' ? 'danger' : user.role === 'user' ? 'primary' : 'secondary'}">
                                    ${user.role}
                                </span>
                            </td>
                            <td>
                                ${user.expires ?
                                    `${user.expires} ${user.days_left !== null ? '(' + user.days_left + ' –¥–Ω.)' : ''}` :
                                    '<span class="text-success">–ë–µ—Å—Å—Ä–æ—á–Ω—ã–π</span>'
                                }
                            </td>
                            <td>
                                <span class="badge bg-${user.is_expired ? 'danger' : 'success'}">
                                    ${user.is_expired ? '–ò—Å—Ç–µ–∫' : '–ê–∫—Ç–∏–≤–µ–Ω'}
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm">
                                    <form method="POST" action="/auth/admin/extend/${user.username}" class="d-inline me-1">
                                        <div class="input-group input-group-sm" style="width: 100px;">
                                            <input type="number" name="days" value="30" min="0" max="365" class="form-control">
                                            <button type="submit" class="btn btn-outline-primary" title="–ü—Ä–æ–¥–ª–∏—Ç—å –¥–æ—Å—Ç—É–ø">+</button>
                                        </div>
                                    </form>
                                    ${user.username !== '{{ session.user }}' ?
                                        `<form method="POST" action="/auth/admin/delete/${user.username}" class="d-inline" onsubmit="return confirm('–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${user.username}?')">
                                            <button type="submit" class="btn btn-outline-danger btn-sm" title="–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è">üóëÔ∏è</button>
                                        </form>` : ''
                                    }
                                </div>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${error.message}</td></tr>`;
                });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        document.getElementById('add-user-form').addEventListener('submit', function(e) {
            const btn = document.getElementById('add-user-btn');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<div class="spinner-border spinner-border-sm me-2"></div>–î–æ–±–∞–≤–ª—è–µ–º...';
            btn.disabled = true;

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
            setTimeout(() => {
                loadUsers();
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 2000);
        });
    </script>
</body>
</html>